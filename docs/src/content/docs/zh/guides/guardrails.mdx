---
title: 护栏
description: Validate or transform agent input and output
---

import { Code } from '@astrojs/starlight/components';
import inputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-input.ts?raw';
import outputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-output.ts?raw';
import toolGuardrailsExample from '../../../../../../examples/docs/guardrails/toolGuardrails.ts?raw';

护栏可以与智能体并行运行，或阻塞执行直至完成，从而让您能够对用户输入或智能体输出执行检查与验证。比如，您可以在调用高成本模型前，先运行一个轻量模型作为护栏。如果护栏检测到恶意使用，它可以触发错误并阻止高成本模型运行。

护栏有两种类型：

1. **输入护栏**在初始用户输入上运行。
2. **输出护栏**在最终智能体输出上运行。

## 输入护栏

输入护栏分三步运行：

1. 护栏接收与传递给智能体相同的输入。
2. 护栏函数执行，并返回一个包装在 [`InputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/inputguardrailresult) 内的 [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput)。
3. 如果 `tripwireTriggered` 为 `true`，则会抛出 [`InputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/inputguardrailtripwiretriggered) 错误。

> **注意**
> 输入护栏用于用户输入，因此只有当该智能体是工作流中的*第一个*智能体时才会运行。护栏配置在智能体本身上，因为不同智能体通常需要不同的护栏。

### 执行模式

- `runInParallel: true`（默认）会让护栏与 LLM/工具调用并行启动。这能最小化延迟，但如果护栏稍后触发，模型可能已经消耗了 token 或运行了工具。
- `runInParallel: false` 会在调用模型**之前**运行护栏，在护栏拦截请求时可避免 token 消耗和工具执行。当您更看重安全与成本而非延迟时，请使用此模式。

## 输出护栏

输出护栏分 3 步运行：

1. 护栏接收智能体产出的输出。
2. 护栏函数执行，并返回一个包装在 [`OutputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/outputguardrailresult) 内的 [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput)。
3. 如果 `tripwireTriggered` 为 `true`，则会抛出 [`OutputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/outputguardrailtripwiretriggered) 错误。

> **注意**
> 输出护栏只有在该智能体是工作流中的*最后一个*智能体时才会运行。对于实时语音交互，请参见[语音智能体指南](/openai-agents-js/zh/guides/voice-agents/build#guardrails)。

## 工具护栏

工具护栏会包装**函数工具**，让您可以在执行前后验证或拦截工具调用。它们配置在工具本身（通过 `tool()` 选项），并会在每次工具调用时运行。

- **工具输入护栏**在工具执行前运行，可用消息拒绝调用或抛出 tripwire。
- **工具输出护栏**在工具执行后运行，可用拒绝消息替换输出或抛出 tripwire。

工具护栏会返回一个 `behavior`：

- `allow` — 继续到下一个护栏或工具执行。
- `rejectContent` — 以一条消息短路（跳过工具调用或替换输出）。
- `throwException` — 立即抛出 tripwire 错误。

工具护栏适用于通过 `tool()` 创建的函数工具。托管工具和内置执行工具（`computerTool`、`shellTool`、`applyPatchTool`）不使用这套护栏管线。

## 跳闸信号

当护栏失败时，会通过 tripwire 发出信号。只要触发了 tripwire，运行器就会抛出对应错误并停止执行。

## 护栏实现

护栏本质上就是一个返回 `GuardrailFunctionOutput` 的函数。下面是一个最小示例：通过在内部运行另一个智能体，检查用户是否在寻求数学作业帮助。

<Code lang="typescript" code={inputGuardrailExample} title="输入护栏示例" />

输出护栏的工作方式相同。

<Code lang="typescript" code={outputGuardrailExample} title="输出护栏示例" />

工具输入/输出护栏如下所示：

<Code lang="typescript" code={toolGuardrailsExample} title="工具护栏" />

1. `guardrailAgent` 在护栏函数内部使用。
2. 护栏函数接收智能体输入或输出并返回结果。
3. 可以在护栏结果中包含额外信息。
4. `agent` 定义了应用护栏的实际工作流。
