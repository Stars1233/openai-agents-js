---
title: 追踪
description: Learn how to trace your agent runs
---

import { Aside, Code } from '@astrojs/starlight/components';
import customTraceExample from '../../../../../../examples/docs/custom-trace.ts?raw';
import cloudflareWorkers from '../../../../../../examples/docs/tracing/cloudflareWorkers.ts?raw';

Agents SDK 内置了追踪功能，可在智能体运行期间收集完整的事件记录：LLM 生成、工具调用、交接、护栏，甚至发生的自定义事件。使用 [Traces dashboard](https://platform.openai.com/traces)，您可以在开发和生产环境中调试、可视化并监控工作流。

<Aside type="note">

在服务器运行时（Node.js、Deno、Bun）中，追踪默认启用。在浏览器中以及 `NODE_ENV=test` 时，追踪默认禁用。

在服务器环境中有两种方式可以禁用追踪：

1. 可通过设置环境变量 `OPENAI_AGENTS_DISABLE_TRACING=1` 全局禁用追踪
2. 可在 `new Runner(...)` 中将 [`RunConfig.tracingDisabled`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#tracingdisabled) 设为 `true`，以在某个 runner 上禁用追踪

**_对于在 OpenAI API 上使用零数据保留（ZDR）策略的组织，追踪功能不可用。_**

</Aside>

## 导出循环生命周期

在受支持的服务器运行时中，追踪会按固定间隔导出。在某些运行时（包括 Cloudflare Workers）中，自动导出循环不可用，但追踪本身仍然启用。在这些环境里，您应在请求生命周期中调用 `getGlobalTraceProvider().forceFlush()`，以便在运行时销毁前导出已排队的追踪数据。

此说明不适用于浏览器，因为浏览器默认禁用追踪。

例如，在 Cloudflare Worker 中，您应将代码包裹在 `try/catch/finally` 块中，并结合 `waitUntil` 使用 `forceFlush()`，以确保在 worker 退出前完成追踪导出。

<Code
  lang="typescript"
  code={cloudflareWorkers.replace(/\s+\/\/ @ts-expect-error.*$/m, '')}
  meta="{13}"
/>

## 追踪与 Span

- **Traces** 表示“工作流”的一次端到端操作，由多个 Span 组成。Traces 具有以下属性：
  - `workflow_name`：逻辑工作流或应用名称，例如“代码生成”或“客户服务”。
  - `trace_id`：追踪的唯一 ID。若未传入会自动生成。格式必须为 `trace_<32_alphanumeric>`。
  - `group_id`：可选分组 ID，用于关联同一对话中的多个追踪。例如可使用聊天线程 ID。
  - `disabled`：若为 True，该追踪不会被记录。
  - `metadata`：追踪的可选元数据。
- **Spans** 表示具有开始和结束时间的操作。Spans 包含：
  - `started_at` 和 `ended_at` 时间戳。
  - `trace_id`，表示其所属追踪
  - `parent_id`，指向该 Span 的父 Span（如有）
  - `span_data`，即该 Span 的信息。例如，`AgentSpanData` 包含智能体信息，`GenerationSpanData` 包含 LLM 生成信息等。

## 默认追踪

默认情况下，SDK 会追踪以下内容：

- 整个 `run()` 或 `Runner.run()` 会被包裹在一个 `Trace` 中。
- 每次智能体运行时，会包裹在 `AgentSpan` 中
- LLM 生成会包裹在 `GenerationSpan` 中
- 每次函数工具调用会包裹在 `FunctionSpan` 中
- 护栏会包裹在 `GuardrailSpan` 中
- 交接会包裹在 `HandoffSpan` 中

默认情况下，追踪名为 “Agent workflow”。如果使用 `withTrace`，可设置该名称；也可通过 [`RunConfig.workflowName`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#workflowname) 配置名称及其他属性。

此外，您还可以设置[自定义追踪处理器](#custom-tracing-processors)，将追踪推送到其他目标（可替代默认目标，或作为次要目标）。

### 语音智能体追踪

如果您使用 `RealtimeAgent` 和 `RealtimeSession` 且采用默认 OpenAI Realtime API，除非在 `RealtimeSession` 中设置 `tracingDisabled: true` 或使用 `OPENAI_AGENTS_DISABLE_TRACING` 环境变量，否则追踪会在 Realtime API 侧自动进行。

更多细节请查看 [语音智能体概述](/openai-agents-js/zh/guides/voice-agents)。

## 更高层级追踪

有时您可能希望多次 `run()` 调用属于同一个追踪。可通过将整段代码包裹在 `withTrace()` 中实现。

<Code lang="typescript" code={customTraceExample} />

1. 由于两次 `run` 调用都包裹在 `withTrace()` 中，单次运行会并入整体追踪，而不是创建两条追踪。

## 追踪创建

您可以使用 [`withTrace()`](/openai-agents-js/openai/agents-core/functions/withtrace/) 函数创建追踪。或者，也可使用 `getGlobalTraceProvider().createTrace()` 手动创建新追踪，并将其传入 `withTrace()`。

当前追踪通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或对应环境的 polyfill 进行跟踪。这意味着它可自动支持并发。

## Span 创建

您可以使用各类 `create*Span()`（例如 `createGenerationSpan()`、`createFunctionSpan()` 等）方法创建 Span。通常无需手动创建 Span。可使用 [`createCustomSpan()`](/openai-agents-js/openai/agents-core/functions/createcustomspan/) 函数跟踪自定义 Span 信息。

Span 会自动归属于当前追踪，并嵌套在最近的当前 Span 下。当前 Span 通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或对应环境的 polyfill 进行跟踪。

## 敏感数据

某些 Span 可能会捕获潜在敏感数据。

`createGenerationSpan()` 会存储 LLM 生成的输入/输出，`createFunctionSpan()` 会存储函数调用的输入/输出。这些内容可能包含敏感数据，因此您可通过 [`RunConfig.traceIncludeSensitiveData`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#traceincludesensitivedata) 禁用这类数据采集。

## OpenAI 追踪导出器

在受支持的服务器运行时中，默认追踪配置已会导出到 OpenAI。当追踪导出需要使用与 `OPENAI_API_KEY` 不同的凭证时，请使用 `setTracingExportApiKey()`。

如果您需要自定义摄取行为，请自行实例化 [`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter)，并通过 `setTraceProcessors(...)` 或 `addTraceProcessor(...)` 安装。该导出器支持 `apiKey`、`endpoint`、`organization`、`project`、`maxRetries`、`baseDelay` 和 `maxDelay`。

如果您替换了默认处理器，之后又想恢复带批处理器的默认 OpenAI 导出器，请调用 [`setDefaultOpenAITracingExporter()`](/openai-agents-js/openai/agents-openai/functions/setdefaultopenaitracingexporter/)。

## 自定义追踪处理器

追踪的高层架构如下：

- 初始化时，我们会创建全局 [`TraceProvider`](/openai-agents-js/openai/agents-core/classes/traceprovider)，其负责创建追踪，并可通过 [`getGlobalTraceProvider()`](/openai-agents-js/openai/agents-core/functions/getglobaltraceprovider/) 访问。
- 我们会将 `TraceProvider` 配置为使用 [`BatchTraceProcessor`](/openai-agents-js/openai/agents-core/classes/batchtraceprocessor/)，后者会将 traces/spans 批量发送到 [`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter/)，再由其批量导出 spans 和 traces 到 OpenAI 后端。

若要自定义该默认配置，以将追踪发送到替代或额外后端，或修改导出器行为，您有两个选项：

1. [`addTraceProcessor()`](/openai-agents-js/openai/agents-core/functions/addtraceprocessor) 允许添加一个**额外**追踪处理器，在 traces 和 spans 就绪时接收它们。这样可在发送到 OpenAI 后端之外进行额外处理。
2. [`setTraceProcessors()`](/openai-agents-js/openai/agents-core/functions/settraceprocessors) 允许用您自己的追踪处理器**替换**默认处理器。这意味着除非您包含可执行该操作的 `TracingProcessor`，否则追踪不会发送到 OpenAI 后端。

## 外部追踪处理器列表

- [AgentOps](https://docs.agentops.ai/v2/usage/typescript-sdk#openai-agents-integration)
- [Keywords AI](https://docs.keywordsai.co/integration/development-frameworks/openai-agents-sdk-js)
