---
title: トレーシング
description: Learn how to trace your agent runs
---

import { Aside, Code } from '@astrojs/starlight/components';
import customTraceExample from '../../../../../../examples/docs/custom-trace.ts?raw';
import cloudflareWorkers from '../../../../../../examples/docs/tracing/cloudflareWorkers.ts?raw';

Agents SDK には組み込みのトレーシングがあり、エージェント実行中のイベントを包括的に記録します。これには LLM の生成、ツール呼び出し、ハンドオフ、ガードレール、さらに発生したカスタムイベントも含まれます。
[Traces ダッシュボード](https://platform.openai.com/traces) を使うことで、開発中および本番環境でワークフローをデバッグ、可視化、監視できます。

<Aside type="note">

トレーシングはサーバーランタイム（ Node.js、Deno、Bun ）ではデフォルトで有効です。ブラウザ環境と `NODE_ENV=test` の場合はデフォルトで無効です。

サーバー環境でトレーシングを無効化する方法は 2 つあります。

1. 環境変数 `OPENAI_AGENTS_DISABLE_TRACING=1` を設定して、グローバルにトレーシングを無効化する
2. `new Runner(...)` で [`RunConfig.tracingDisabled`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#tracingdisabled) を `true` に設定して、 runner 単位で無効化する

**_OpenAI の API を Zero Data Retention（ ZDR ）ポリシーで運用している組織では、トレーシングは利用できません。_**

</Aside>

## エクスポートループのライフサイクル

対応するサーバーランタイムでは、トレースは一定間隔でエクスポートされます。一部のランタイム（ Cloudflare Workers など）では、トレーシング自体は有効でも自動エクスポートループは利用できません。そのような環境では、ランタイム終了前にキューされたトレースをエクスポートするため、リクエストライフサイクル内で `getGlobalTraceProvider().forceFlush()` を呼び出してください。

このガイダンスはブラウザには適用されません。ブラウザではトレーシングがデフォルトで無効のためです。

たとえば Cloudflare Worker では、コードを `try/catch/finally` ブロックで囲み、`waitUntil` とともに `forceFlush()` を使って worker 終了前にトレースが確実にエクスポートされるようにしてください。

<Code
  lang="typescript"
  code={cloudflareWorkers.replace(/\s+\/\/ @ts-expect-error.*$/m, '')}
  meta="{13}"
/>

## トレースとスパン

- **Traces** は 1 つの「ワークフロー」に対するエンドツーエンドの単一操作を表します。Traces は Spans で構成されます。Traces には次のプロパティがあります
  - `workflow_name`: 論理的なワークフローまたはアプリ。例: 「 Code generation 」「 Customer service 」
  - `trace_id`: トレースの一意な ID。指定しない場合は自動生成されます。形式は `trace_<32_alphanumeric>` である必要があります
  - `group_id`: 任意のグループ ID。同じ会話に属する複数トレースを関連付けるために使用します。例: チャットスレッド ID
  - `disabled`: True の場合、トレースは記録されません
  - `metadata`: トレース用の任意メタデータ
- **Spans** は開始時刻と終了時刻を持つ操作を表します。Spans には次があります
  - `started_at` と `ended_at` のタイムスタンプ
  - `trace_id`: 所属するトレースを表す ID
  - `parent_id`: この Span の親 Span を指す ID（存在する場合）
  - `span_data`: Span に関する情報。例: `AgentSpanData` は Agent 情報、`GenerationSpanData` は LLM 生成情報を含みます

## デフォルトトレーシング

デフォルトでは、SDK は次をトレースします。

- `run()` または `Runner.run()` 全体を `Trace` でラップ
- エージェントが実行されるたびに `AgentSpan` でラップ
- LLM 生成を `GenerationSpan` でラップ
- 関数ツール呼び出しごとに `FunctionSpan` でラップ
- ガードレールを `GuardrailSpan` でラップ
- ハンドオフを `HandoffSpan` でラップ

デフォルトでトレース名は "Agent workflow" です。`withTrace` を使う場合はこの名前を設定できます。`[`RunConfig.workflowName`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#workflowname)` で名前やその他のプロパティを設定することもできます。

さらに、[カスタムトレースプロセッサー](#custom-tracing-processors) を設定して、トレースを別の送信先へ送ることもできます（置き換えまたは二次送信先として）。

### 音声エージェントのトレーシング

`RealtimeAgent` と `RealtimeSession` をデフォルトの OpenAI Realtime API とともに使用している場合、`RealtimeSession` で `tracingDisabled: true` を設定するか、環境変数 `OPENAI_AGENTS_DISABLE_TRACING` を使って無効化しない限り、Realtime API 側で自動的にトレーシングが行われます。

詳細は [音声エージェントの概要](/openai-agents-js/ja/guides/voice-agents) を参照してください。

## 上位レベルトレース

場合によっては、複数の `run()` 呼び出しを 1 つのトレースにまとめたいことがあります。これはコード全体を `withTrace()` でラップすることで実現できます。

<Code lang="typescript" code={customTraceExample} />

1. 2 つの `run` 呼び出しが `withTrace()` でラップされているため、個別に 2 つのトレースを作成するのではなく、全体トレースの一部になります。

## トレースの作成

トレースの作成には [`withTrace()`](/openai-agents-js/openai/agents-core/functions/withtrace/) 関数を使えます。あるいは `getGlobalTraceProvider().createTrace()` で新しいトレースを手動作成し、`withTrace()` に渡すこともできます。

現在のトレースは [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) または各環境の polyfill で追跡されます。これにより並行処理でも自動的に動作します。

## スパンの作成

スパンの作成には各種 `create*Span()`（例: `createGenerationSpan()`、`createFunctionSpan()` など）を使えます。通常は手動でスパンを作成する必要はありません。カスタムスパン情報を追跡するために [`createCustomSpan()`](/openai-agents-js/openai/agents-core/functions/createcustomspan/) 関数も用意されています。

スパンは自動的に現在のトレースの一部となり、現在の最も近いスパンの子としてネストされます。これは [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) または各環境の polyfill で追跡されます。

## 機密データ

一部のスパンは機密性の高い可能性があるデータを取得する場合があります。

`createGenerationSpan()` は LLM 生成の入力 / 出力を保存し、`createFunctionSpan()` は関数呼び出しの入力 / 出力を保存します。これらには機密データが含まれる可能性があるため、[`RunConfig.traceIncludeSensitiveData`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#traceincludesensitivedata) でその取得を無効化できます。

## OpenAI トレーシングエクスポーター

対応するサーバーランタイムでは、デフォルトのトレーシング設定ですでに OpenAI へエクスポートされます。トレースエクスポートで `OPENAI_API_KEY` と異なる資格情報を使う場合は `setTracingExportApiKey()` を使用してください。

取り込み動作をカスタマイズする必要がある場合は、[`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter) を自分で生成し、`setTraceProcessors(...)` または `addTraceProcessor(...)` で設定してください。エクスポーターは `apiKey`、`endpoint`、`organization`、`project`、`maxRetries`、`baseDelay`、`maxDelay` をサポートします。

デフォルトプロセッサーを置き換えたあとで、バッチプロセッサー付きのデフォルト OpenAI エクスポーターを復元したい場合は、[`setDefaultOpenAITracingExporter()`](/openai-agents-js/openai/agents-openai/functions/setdefaultopenaitracingexporter/) を呼び出してください。

## カスタムトレースプロセッサー

トレーシングの高レベルなアーキテクチャは次のとおりです。

- 初期化時に、トレース作成を担うグローバル [`TraceProvider`](/openai-agents-js/openai/agents-core/classes/traceprovider) を作成し、[`getGlobalTraceProvider()`](/openai-agents-js/openai/agents-core/functions/getglobaltraceprovider/) からアクセスできます
- `TraceProvider` に [`BatchTraceProcessor`](/openai-agents-js/openai/agents-core/classes/batchtraceprocessor/) を設定し、トレース / スパンをバッチで [`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter/) へ送り、さらに OpenAI バックエンドへバッチエクスポートします

このデフォルト設定をカスタマイズして、別または追加のバックエンドへトレースを送る、あるいはエクスポーターの動作を変更するには、次の 2 つの方法があります。

1. [`addTraceProcessor()`](/openai-agents-js/openai/agents-core/functions/addtraceprocessor) は、準備できたトレースとスパンを受け取る **追加** のトレースプロセッサーを追加します。OpenAI バックエンドへの送信に加えて独自処理を行えます
2. [`setTraceProcessors()`](/openai-agents-js/openai/agents-core/functions/settraceprocessors) は、デフォルトプロセッサーを独自のトレースプロセッサーで **置き換え** ます。これは `TracingProcessor` を含めない限り、トレースが OpenAI バックエンドへ送信されないことを意味します

## 外部トレーシングプロセッサー一覧

- [AgentOps](https://docs.agentops.ai/v2/usage/typescript-sdk#openai-agents-integration)
- [Keywords AI](https://docs.keywordsai.co/integration/development-frameworks/openai-agents-sdk-js)
